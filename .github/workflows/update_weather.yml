name: Update Suwon Weather

on:
  schedule:
    # 매 30분마다 (UTC 기준). 한국 시간과 상관없이 30분 간격으로 실행된다고 보시면 됩니다.
    - cron: "*/30 * * * *"
  workflow_dispatch: # 필요하면 GitHub UI에서 수동으로도 실행할 수 있게 함
    inputs: {}

permissions:
  contents: write   # GITHUB_TOKEN으로 커밋/푸시하려면 contents: write 권한 필요

jobs:
  update-weather:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Generate Suwon weather JSON
        env:
          WEATHER_PROVIDER: ${{ secrets.WEATHER_PROVIDER }}
          KMA_SERVICE_KEY: ${{ secrets.KMA_SERVICE_KEY }}
          AIR_PROVIDER: ${{ secrets.AIR_PROVIDER }}
          KMA_AIR_SIDO_NAME: ${{ secrets.KMA_AIR_SIDO_NAME }}
        run: |
          export WEATHER_PROVIDER=${WEATHER_PROVIDER:-kma}
          export AIR_PROVIDER=${AIR_PROVIDER:-$WEATHER_PROVIDER}
          export KMA_AIR_SIDO_NAME=${KMA_AIR_SIDO_NAME:-경기도}

          run_provider="$WEATHER_PROVIDER"
          run_air="$AIR_PROVIDER"

          # 키가 없으면 KMA 시도 대신 open-meteo로 자동 폴백
          if { [ "$run_provider" = "kma" ] || [ "$run_air" = "kma" ]; } && [ -z "$KMA_SERVICE_KEY" ]; then
            echo "[WARN] KMA_SERVICE_KEY not set. Falling back to open-meteo for weather/air." >&2
            run_provider="open-meteo"
            if [ -z "$AIR_PROVIDER" ]; then
              run_air="open-meteo"
            fi
          fi

          python fetch_weather.py \
            --provider "$run_provider" \
            --air-provider "$run_air" \
            --kma-air-sido-name "$KMA_AIR_SIDO_NAME" \
            || {
              if [ "$run_provider" = "kma" ]; then
                echo "[WARN] KMA fetch failed, retrying with open-meteo." >&2
                run_provider="open-meteo"
                if [ -z "$AIR_PROVIDER" ]; then
                  run_air="open-meteo"
                fi
                python fetch_weather.py \
                  --provider "$run_provider" \
                  --air-provider "$run_air" \
                  --kma-air-sido-name "$KMA_AIR_SIDO_NAME"
              fi
            }

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/src_weather.json

          # 변경사항이 없으면 commit이 실패하니까, 실패해도 무시하도록 처리
          git commit -m "Update Suwon weather data" || echo "No changes to commit"

          git push origin HEAD:main
